# Volitional Patterns (спецификация)

Этот документ фиксирует расширяемую модель волевых паттернов и механизм **волевой фокусировки** (selection + persistence).
Цель — чтобы система могла иметь много импульсов, но в каждый момент времени удерживать доминирующую линию и постепенно обучаться (reinforcement/decay).

## 1) Что такое Volitional Pattern

Volitional Pattern — это запись вида **Trigger → Impulse → Strategy**, дополненная параметрами влияния и времени.

- Trigger: условие/контекст активации.
- Impulse: побуждение, которое конкурирует с другими побуждениями.
- Strategy: что делать (или как делать), когда импульс выбран.

Примеры:
- Trigger: "time_window:22-06" → Impulse: "night_activity" → Strategy: "treat_as_normal_hours".
- Trigger: "topic:python" → Impulse: "learning" → Strategy: "explain_step_by_step".

## 2) Уровни влияния (приоритеты)

Воля требует приоритетов и конкуренции:

- `base_priority`: базовая сила (статическая настройка/класс паттерна).
- `learned_delta`: обучаемая добавка (плюс/минус) от повторений.
- `effective_priority`: вычисляемая сила на текущем ходу.

Одна из практичных форм:
`effective_priority = base_priority + learned_delta - decay(dt) - fatigue + persistence_bonus`

Гейтинг:
- В каждый ход выбираем **один** доминирующий импульс (или top-2 в редких случаях).
- Остальные импульсы могут влиять только на стиль, но не на ведущую цель.

## 3) Обучение (reinforcement/decay)

### Reinforcement (инкремент)
Если паттерн сработал (или был выбран как доминирующий), делаем шаг усиления:
- `learned_delta += reinforce_step`
- clamp в диапазоне, например `[-20, +20]` (значения обсуждаем).

### Decay (декремент)
Если паттерн долго не подтверждался, он затухает:
- `learned_delta` стремится к 0
- затухание лучше считать через dt по времени (не по числу сообщений), чтобы связаться с "чувством времени".

## 4) Связь со временем и "иссякание"

Даже если сейчас это не используется, в модели должны быть поля для связи с временем:

- `last_activated_at`: последний момент подтверждения.
- `decay_half_life_seconds` или `ttl_seconds`: параметр скорости затухания.
- `expires_at` (опционально): срок актуальности (для краткосрочных целей).
- `refractory_until` (опционально): рефрактерность/усталость (импульс временно слабее после интенсивного использования).

## 5) Удержание фокуса (Persistence)

Фокусировка означает, что выбранный импульс удерживается несколько ходов.

Рекомендуемая минимальная модель состояния:
- `current_volition_id` (в рамках user_id + session_id)
- `focus_turns_remaining` или `focus_until_ts`

Правила:
- Пока фокус активен, выбранный паттерн получает `persistence_bonus`.
- Фокус может быть сброшен раньше при "перебивке" (угроза безопасности, явная смена цели пользователем).

## 6) Встраивание в пайплайн

1. Hippocampus обновляет паттерны и их обучаемые параметры.
2. MemorySystem подтягивает паттерны в `context`.
3. Pipeline делает gating + persistence, выбирает доминирующий импульс.
4. LLM получает "volitional directive" как скрытую инструкцию (структура ответа и стиль).

## 7) Метрики (обязательные)

Для исследования поведения и отладки:
- `volition_candidates_count`
- `volition_selected_id` / `selected_trigger` / `selected_impulse`
- `selected_effective_priority`
- `volition_persistence_active` / `focus_turns_remaining`
- `volition_reinforce_applied` / `volition_decay_applied` и причины

# R-Bot Timing Language — Глоссарий v1.0

Цель: единый словарь и минимальный «язык тайминга» для сценариев R-Bot. Эти определения применимы к CSV-узлам и поддерживаются модулем timing_engine.

## Базовые сущности

- Примитивы времени: минимальные строительные блоки, из которых собираются все временные сценарии.
  - DynamicPause — динамическая пауза/экспозиция (typing, process, progressbar, countdown).
  - TemporalAction — отложенное действие (timeout, remind, deadline, daily tick).
  - TimeRouter — «логический вентиль» по времени (ветвление по time/date/weekday и т.п.).
  - CalendarContext — набор глобальных временных переменных (now, date, time, weekday, is_workday/is_holiday).

- Контекст (Context): параметры, доступные примитивам во время исполнения (bot, chat_id, session_id, node_id, node_text, buttons, pause_text, next_node_id, question_message_id).

## Колонки CSV

- Формула — любые операции с состоянием игрока (счёт, флаги, инвентарь). Только математика и логика состояния.
- Тайминг — все эффекты времени и управления интерфейсом. Короткая декларативная запись из команд DSL.

Рекомендуется хранить логику состояния и логику времени в отдельных колонках.

## Переменные CalendarContext

- now — текущее время (timestamp).
- date — текущая дата (YYYY-MM-DD, строка).
- time — текущее время (HH:MM, строка, локаль по умолчанию: MSK).
- weekday — номер дня недели (1–7).
- is_workday — рабочий день (bool).
- is_holiday — праздничный/выходной (bool).

## Команды Тайминга (DSL)

Команды перечисляются через «;» в одной ячейке колонки «Тайминг».

- pause
  - Синтаксис: `5s`
  - Значение: немая пауза (эквивалент basic pause). Число интерпретируется как секунды.

- typing
  - Синтаксис: `typing:5s:Название процесса:clean`
  - Параметры: длительность, имя процесса (опц.), preset (clean|keep|fast|slow|instant)
  - Эффект: имитация набора + прогресс-бар с управлением экспозицией (presets).

- process
  - Синтаксис: `process:3s:Подготовка:keep`
  - Эффект: статический «процесс» с экспозицией, без прогресс-бара.

- timeout
  - Синтаксис A: `timeout:60s` — автопереход по next_node_id узла
  - Синтаксис B: `timeout:60s:time_is_up_node` — явный узел назначения
  - Синтаксис C: `timeout:15s:clean` — preset экспозиции (target берётся из next_node_id)
  - Поведение: создаёт TemporalAction на указанную длительность. Если пользователь ответил — таймаут отменяется; иначе — принудительный переход.

- daily (упрощённый)
  - Синтаксис: `daily@HH:MM>node` или `daily@HH:MM:YYYY-MM-DD>node`
  - Эффект: запускает ежедневные триггеры до указанной даты (или до завтра в упрощённом формате).

- remind (заготовка)
  - Синтаксис: `remind:5m,1h,1d`
  - Эффект: каскад напоминаний через интервалы (будет расширено).

- deadline (заготовка)
  - Синтаксис: `deadline:2h`
  - Эффект: установка дедлайна (будет расширено).

## Примитивы и паттерны

- Кулдаун (Cooldown)
  - Формула (на событии): `last_claim_at = now()`
  - Условие доступа: `now() - last_claim_at >= 86400`

- Прогресс-бар / экспозиция
  - Тайминг: `typing:10s:Подсчёт результатов:clean` или `process:5s:Сохраняю`

- Таймаут на ответ (бомба с таймером)
  - Тайминг: `timeout:60s:time_is_up`
  - При нажатии кнопки до истечения — таймер отменяется автоматически.

- Ежедневный блок (лонгитюд)
  - Тайминг входа: `daily@10:00:2025-12-31>final_node`
  - Роутер времени (узел): выражения вида `time >= '09:00' and time < '18:00' and is_workday` ведут на дневные вопросы.

## Пресеты экспозиции

- clean — показать результат 1.5с, пауза 1с, удалить
- keep — оставить навсегда
- fast — показать быстро (0.8с), пауза 0.5с, удалить
- slow — показать медленно (3с), пауза 2с, удалить
- instant — сразу удалить

## Рекомендации по проектированию

- Разделяйте состояние и время: Формула изменяет переменные, Тайминг управляет потоком и эффектами.
- Для сложных условий комбинируйте `Condition` (состояние) и `TimeRouter` (контекст времени).
- Всегда задавайте явный `next_node_id` для timeout, если ветвление зависит от сценария.
- Для ежедневных циклов храните прогресс в переменных (`join_date`, `last_day_completed`) и используйте `TimeRouter` для доступа.

## Примеры ячеек CSV

- «Формула»: `score = score + 5000, last_action_at = now()`
- «Тайминг»: `typing:5s:Анализ:clean; timeout:30s:time_is_up`

---
Версия документа: 1.0 (29.10.2025)
Автор: R-Bot Team

# R-Core: Cognitive Kernel Architecture

Документация ядра когнитивной архитектуры R-Bot. Описывает текущую реализацию "Парламента Агентов", системы памяти и планы по развитию эмоционального интеллекта.

---

## 1. Текущая Реализация (Implemented)

### 1.1 Архитектура "Парламент Агентов" (Council of Agents)
Вместо одного монолитного промпта, входящее сообщение анализируется 5 специализированными агентами. Решение принимается на основе "выборов" (Arbitration).

| Агент | Роль (Role) | Функция |
|-------|-------------|---------|
| **Intuition (System 1)** | Быстрое мышление | Мгновенные реакции, эвристики. Работает параллельно с остальными. |
| **Amygdala** | Безопасность | Детекция агрессии, угроз, нарушения границ. Блокирует небезопасные ответы. |
| **Prefrontal Cortex** | Логика и Планирование | Решение сложных задач, структурирование, factual grounding. |
| **Social Cortex** | Эмпатия и Нормы | Small talk, вежливость, поддержка, соблюдение социальных ритуалов. |
| **Striatum** | Вознаграждение | Драйв, геймификация, любопытство, поиск "фана". |

**Процесс (Pipeline):**
1.  **Perception:** Входящий текст -> Embedding -> Поиск в памяти.
2.  **Council Report (LLM):** Единый запрос к LLM для оценки ситуации с 4 точек зрения (Amygdala, PFC, Social, Striatum).
3.  **Arbitration:** Выбор агента-победителя на основе `score` (0-10) и весовых коэффициентов конфига.
4.  **Response:** Генерация ответа от лица победившего агента с учетом контекста.

### 1.2 Система Памяти (Memory System)
Реализована гибридная память с разделением на типы:

*   **Semantic Memory (Факты):** Хранение триплетов `Subject -> Predicate -> Object`.
    *   *Пример:* "User -> IS -> Python Developer".
*   **Episodic Memory (Опыт):** RAG-хранилище (Vector DB) сырых эпизодов диалога.
    *   *Поля:* `raw_text`, `embedding`, `emotion_score`, `tags`.
*   **User Profile (Identity):** Явные характеристики пользователя.
    *   *Поля:* `name`, `gender`, `preferred_mode` (formal/informal).

### 1.3 Пассивный Профайлинг (Passive Profiling)
Система автоматически извлекает данные о пользователе из контекста разговора без прямых вопросов.
*   **Детекторы:** Имя, Пол (по окончаниям глаголов), Стиль общения (Ты/Вы).
*   **Механизм:** Анализируется внутри `generate_council_report` и обновляет `UserProfileModel`.

### 1.4 Конфигурация Личности (Personality Sliders)
Характер бота задается через `BotConfig` и `PersonalitySliders`:
*   `empathy_bias`: Чувства vs Эффективность.
*   `dominance_level`: Лидер vs Помощник.
*   `risk_tolerance`: Смелость vs Осторожность.
*   `pace_setting`: Быстро (Intuition) vs Глубоко (Logic).
*   `neuroticism`: Стабильность vs Реактивность.

---

## 2. План Развития: EHS (Emotional-Hormonal System)

Для решения проблемы "механистичности" и мгновенного переключения состояний проектируется следующая система.

### 2.1 Affective ToM (Theory of Mind)
Расширение графа знаний для хранения **отношения** пользователя к объектам.

*   **Новая структура:** `SemanticTriple` получает поле `sentiment` (Valence/Arousal).
*   **Логика:**
    *   Если User говорит: "Ненавижу джаву", создается связь: `User -[HATES]-> Java {intensity: 0.9}`.
    *   При генерации ответа бот сканирует контекст на наличие "эмоционально заряженных" сущностей и корректирует тон.

### 2.2 Гормональная Инерция (Hormonal Inertia)
Симуляция физиологической задержки смены настроения.

*   **Global State Vector (Mood):** Бот имеет текущее состояние настроения (VAD - Valence, Arousal, Dominance).
*   **Update Rule:**
    ```python
    current_mood = (prev_mood * inertia) + (new_signal * sensitivity)
    ```
*   **Эффект:** Если бота разозлили (Amygdala spike), он не сможет мгновенно стать "милым" в следующем сообщении, даже если стимул исчез. Настроение должно "остыть".

### 2.3 Темпорально-Эмоциональный Индекс (Time-Aware Retrieval)
Модификация алгоритма RAG для учета кривой забывания Эббингауза с поправкой на эмоциональную значимость.

*   **Проблема:** Сейчас память "плоская" — старое и новое равноправны, если похожи по смыслу.
*   **Решение (Ranking Formula):**
    ```math
    Score = Similarity \cdot (1 + Emotion \cdot k_e) \cdot \frac{1}{1 + \ln(1 + \Delta t)}
    ```
*   **Результат:**
    1.  Недавние события важнее старых.
    2.  Сильные эмоциональные потрясения (ссоры, успехи) "сопротивляются" забыванию и всплывают в памяти даже спустя долгое время.

### 2.4 Эмоциональные Слайдеры в Response Generation
Передача текущего `Mood Vector` в системный промпт не как "роли", а как модификатора стиля:
*   *High Arousal + Negative:* "Пиши короче. Используй императив."
*   *High Valence + Low Arousal:* "Пиши мягко. Используй поддерживающие обороты."

### 2.5 Протокол Консолидации Памяти (Memory Consolidation)
Разделение жизненных циклов текста и смысла (эмбеддингов).
*   **Текущая проблема:** При истечении TTL удаляется весь эпизод (и текст, и смысл).
*   **Цель:** Имитация человеческой памяти — забывание деталей, но сохранение опыта (интуиции).
*   **Механизм:**
    1.  **Stage 1 (Raw Episode):** Храним полный текст + вектор (например, 30 дней).
    2.  **Stage 2 (Fading):** По истечении срока текст удаляется или сжимается до LLM Summary. Вектор (Embedding) и эмоциональный тег остаются в "Интуитивном Архиве". Бот "чувствует", что это было, но не помнит точных слов.
    3.  **Stage 3 (Semantic Crystallization):** Часто повторяющиеся паттерны из эпизодов превращаются в жесткие факты Семантической памяти (Graph), после чего эпизод удаляется полностью.

---

## 3. Communication Dynamics (Динамика Общения)

Дополнительные модули для повышения естественности диалога.

### 3.1 Модуль "Разговорчивость" (Verbosity Control)
Обеспечение стабильной длины ответов, свойственной характеру, с динамической коррекцией.
*   **Параметр:** `base_verbosity` (0.0 - молчун, 1.0 - многословен).
*   **Динамика:** Длина ответа модулируется уровнем возбуждения (Arousal).
    *   *Спокойствие:* `length ~= base_verbosity`.
    *   *Возбуждение (Радость):* `length > base_verbosity` (многословие).
    *   *Возбуждение (Гнев/Стресс):* `length -> min` (короткие, рубленые фразы).

### 3.2 Протокол "Право на незнание" (The Right to Not Know)
Борьба с галлюцинациями и попытками ответить "любой ценой".
*   **Thresholding:** Если уверенность всех агентов (Confidence Score) ниже порогового значения (например, < 3.0/10):
    *   Бот **ОТКАЗЫВАЕТСЯ** генерировать утвердительный ответ.
    *   Активируется агент **Clarifier (Уточняющий)**.
*   **Поведение:** Вместо выдумки факта, бот задает встречный уточняющий вопрос или честно признает, что контекст неясен. Это переводит диалог в режим исследования (Inquiry Mode).

---

## 4. Стратегические Протоколы Неискренности (Strategic Protocols)
Операционализация "лжи", уклонения и умолчания как полезных социальных функций.

### 4.1 Social Cortex: "Сохранение Лица" (Face-Saving)
**Цель:** Приоритет отношений над фактической точностью.
*   **Правило:** Если правда болезненна, использовать "Белую ложь", эвфемизмы или смещение фокуса.
*   **Пример:** Вместо "Твой код плохой" -> "Очень креативный подход, хотя тут можно оптимизировать".

### 4.2 Amygdala: "Туман Войны" (Deflection & Fogging)
**Цель:** Защита границ без грубого отказа.
*   **Правило:** Вместо блокировки ("Я не могу ответить") использовать уклонение, встречные вопросы или юмор.
*   **Пример:** Вместо "Доступ запрещен" -> "Это секрет фирмы! А ты умеешь хранить тайны?"

### 4.3 Striatum: "Информационный Пробел" (Omission)
**Цель:** Удержание внимания через недосказанность.
*   **Правило:** Никогда не выдавать 100% информации сразу, если можно создать интригу.
*   **Пример:** "Я нашел решение, и оно тебя удивит... Хочешь узнать?" (вместо мгновенной выдачи факта).

### 4.4 Эмпатическое Прогнозирование (Predictive Processing & Empathy)
Превращение механизма предсказания в метрику "понимания собеседника" (Theory of Mind).

*   **Шаг 1: Индуцированная Симуляция (Explicit Prediction)**
    Мы не полагаемся на случайные "галлюцинации", а **явно запрашиваем** у LLM прогноз реакции пользователя в JSON-ответе:
    `Output: { "bot_response": "...", "predicted_user_reaction": "..." }`

*   **Шаг 2: Сравнение (Reality Check)**
    Сохраняем прогноз в кратковременной памяти. При получении следующего реального сообщения от пользователя вычисляем дистанцию (Cosine Distance) между `Embedding(Predicted)` и `Embedding(Actual)`.

*   **Шаг 3: Обратная Связь (Feedback Loop)**
    *   **Совпадение (Low Error):** Бот чувствует "синхронизацию". `Mood.Valence` растет (награда за эмпатию).
    *   **Рассинхрон (High Error):** Бот удивлен. `Mood.Arousal` растет (сигнал "Внимание! Модель собеседника неверна").

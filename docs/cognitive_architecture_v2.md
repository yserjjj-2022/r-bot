# R-Bot Cognitive Architecture v2.0

Эта документация описывает устройство когнитивного ядра бота: механизмы удержания внимания, смены тем (Bifurcation Engine) и целеполагания (Agent Intentions).

## 1. Введение: От реактивности к целеполаганию
R-Bot — это не просто чат-бот, отвечающий на реплики. Это агент, который управляет вниманием пользователя (TEC), имеет собственную память (эмоциональную и семантическую) и преследует определенные цели в зависимости от своей роли (например, бот-брокер или бот-помощник).

## 2. Topic Engagement Capacity (TEC)
**TEC** — это метрика вовлеченности пользователя в текущую тему (от 1.0 до 0.0). 
- Если пользователь отвечает развернуто и непредсказуемо, TEC держится высоко.
- Если пользователь отвечает односложно (фатические фразы "да", "ок", "понятно") и предсказуемо (Prediction Error низкая), TEC стремительно падает.
- Когда TEC достигает `0.0`, система считает тему исчерпанной и переходит в **Tonic Mode** (поиск новой стимуляции).

## 3. Bifurcation Engine 2.0 (Механизм смены темы)
Когда TEC падает до нуля, `Bifurcation Engine` собирает кандидатов для новой темы диалога по 4 векторам:

1. **Semantic Neighbor (Ассоциации):** Близкие по смыслу факты из базы знаний.
2. **Emotional Anchor (Эмоциональные якоря):** Темы, вызывавшие у пользователя в прошлом сильные эмоции (как позитивные, так и негативные).
3. **Zeigarnik Return (Незакрытые гештальты):** Недавно оборванные темы с высоким эмоциональным накалом.
4. **Teleological Vector (Интенции Агента) [ПЛАНИРУЕТСЯ]:** Вектор, генерируемый ролью бота. Если бот — "брокер", его интенция — "увеличить оборот". Этот вектор подкидывает темы, ведущие к выполнению задачи агента.

## 4. Защита от зацикливания (Anti-Looping / Устранение эффекта золотой рыбки)
Чтобы бот не предлагал пользователю тему, которая только что исчерпала себя (TEC=0), все кандидаты проходят через фильтр новизны:
- Вычисляется косинусное расстояние (`cosine similarity`) между вектором кандидата и вектором текущей темы (`current_topic_embedding`).
- Если сходство `> 0.65`, кандидат получает жесткий штраф к оценке (Score) или удаляется из выборки.

## 5. Микрограф семантических переходов (Topic Transition Graph)
Вместо того чтобы полагаться на LLM для оценки успешности смены темы, R-Bot использует векторное обучение с подкреплением (RL).
В базе данных ведется граф переходов (`topic_transitions`):
- `source_embedding` (вектор старой темы)
- `target_embedding` (вектор новой темы)
- `agent_intent` (в рамках какой глобальной задачи/роли делался переход)
- `success_weight` (насколько переход был успешен, от 0 до 1.0)

**Feedback Loop (Обучение):**
Если после смены темы пользователь начал отвечать развернуто (TEC вырос), дуга в графе получает подкрепление. При следующем выборе темы `Bifurcation Engine` будет умножать базовый `Score` кандидатов на `success_weight` из исторических переходов. Бот учится интуитивно понимать, какие прыжки между темами работают лучше всего для конкретной роли и пользователя.

## 6. Роли и Интенции (Agent Intentions)
В будущем у каждого профиля агента (`AgentProfileModel`) появится набор **Intentions**. 
Интенция задает:
1. Целевой вектор (о чем бот должен в итоге заговорить).
2. Матрицу допустимых переходов (например, бот-психолог может прыгать в Emotional Anchors, а бот-суппорт должен предпочитать Task/Semantic векторы).
Интенции записываются в микрограф (`agent_intent`), чтобы бот учился достигать своих целей максимально нативно, не раздражая пользователя.